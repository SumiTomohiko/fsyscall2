#!/bin/sh

dir="$(dirname $0)"
tests_dir="${dir}/tests"
tester="${tests_dir}/tester/tester"
tmp_dir="${dir}/tmp.tests"
arch=$(uname -p)

rm -rf "${tmp_dir}" || exit 1
mkdir -p "${tmp_dir}" || exit 1

find "${tests_dir}" -name "test_*" | sort | while read t
do
	echo "******** ${t} ********"

	unset args cmd expected_status expected_stdout status
	. "${t}"

	type precmd >/dev/null 2>&1
	if [ "${?}" = 0 ]; then
		precmd
	fi

	exe="${tests_dir}/${arch}/${cmd}"
	stdout_log="${tmp_dir}/stdout.log"
	"${tester}" "${exe}" ${args} > "${stdout_log}"
	status="${?}"

	if [ -n "${expected_status}" ]; then
		if [ "${expected_status}" = "${status}" ]; then
			result="OK"
		else
			result="NG"
		fi
	elif [ -n "${expected_stdout}" ]; then
		if [ "${expected_stdout}" = "$(cat ${stdout_log})" ]; then
			result="OK"
		else
			result="NG"
		fi
	else
		testcmd
		if [ "${?}" = "0" ]; then
			result="OK"
		else
			result="NG"
		fi
	fi
	echo "${t}: ${result}"

	type postcmd >/dev/null 2>&1
	if [ "${?}" = 0 ]; then
		postcmd
	fi
done

rm -rf "${tmp_dir}" || exit 1
